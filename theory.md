# 蒙特卡罗方法采样算法

&emsp;&emsp;蒙特卡罗方法(`Monte Carlo Simulation`)是一种随机模拟(或者统计模拟)方法。

&emsp;&emsp;给定统计样本集，如何估计产生这个样本集的随机变量概率密度函数,是我们比较熟悉的概率密度估计问题。
求解概率密度估计问题的常用方法是最大似然估计、最大后验估计等。但是,我们思考概率密度估计问题的逆问题:给定一个概率分布`p(x)`，如何让计算机生成满足这个概率分布的样本。
这个问题就是统计模拟中研究的重要问题–采样(`Sampling`)。本文将重点介绍其中两种重要的采样算法：`MCMC(Markov Chain Monte Carlo)`算法和`Gibbs Sampling`算法。

## Sampling

&emsp;&emsp;一般而言均匀分布`Uniform(0,1)`的样本是相对容易生成的。 通过线性同余发生器可以生成伪随机数，我们用确定性算法生成`[0,1]`之间的伪随机数序列后，
这些序列的各种统计指标和均匀分布`Uniform(0,1)`的理论计算结果非常接近。这样的伪随机序列就有比较好的统计性质，可以被当成真实的随机数使用。线性同余随机数生成器如下:

$$x_{n+1}=(ax_n+c)~\textrm{mod}~m$$

&emsp;&emsp;式中`aa`，`cc`，`mm`是数学推导出的合适的常数。这种算法产生的下一个随机数完全依赖当前的随机数，当随机数序列足够大的时候，随机数会出现重复子序列的情况。
当然，也有很多更加先进的随机数产生算法出现，比如`numpy`用的是 `Mersenne Twister` 等。根据上面的算法现在我们有了均匀分布的随机数，但是如何产生满足其他分布下的随机数呢？

&emsp;&emsp;首先我们来看一个简单的例子，假设我们想对下面的二项分布进行采样:

$$P(X=0)=0.5 ~,~ P(X=1)=0.5$$

&emsp;&emsp;我们如何采样得到$X$的值。我们会很毫不费力地想到“抛硬币”，如果硬币正面朝上，则$X=1$，否则，$X=0$。那计算机怎么做，使用随机数生成器生成0到1之间的随机数$r$，
如果$r<0.5$，则$X=1$，否则，$X=0$。当分布是多项式分布时:

$$P(X=i)=1/6 ~,~ i\in{1,2,...,6}$$

&emsp;&emsp;这也很简单，让算机生成0到1之间的随机数$r$，把0到1等分成6个子区间，$r$落在哪个区间，$X$就取值为那个区间的编号。我们再考虑更复杂的情况，假设分布是多元随机变量分布:

$$P(X_1,X_2,...,X_n)$$

&emsp;&emsp;当然这种情况下也有容易解决的例子，比如随机变量都是独立的情形:

$$P(X_1,X_2,...,X_n)=P(X_1)P(X_2)...P(X_n)$$

&emsp;&emsp;我们可以利用前面的算法对每个变量单独进行采样。但是问题并不总是这么简单，当$P(X)$的形式很复杂，或者$P(X)$是个高维的分布且不能分解的时候，样本的生成就可能很困难了。
此时就需要使用一些更加复杂的随机模拟的方法来生成样本。而本节中将要重点介绍的 `MCMC` 算法和 `Gibbs Sampling` 算法就是最常用的两种，这两个方法在现代贝叶斯分析中被广泛使用。
要了解这两个算法，我们首先要对马尔科夫链的平稳分布的性质有基本的认识。

## 马尔科夫链及其平稳分布

&emsp;&emsp;马尔科夫链的数学定义如下:

$$P(X_{t+1}=x|X_t,X_{t-1},...)=P(X_{t+1}=x|X_t)$$

&emsp;&emsp;也就是说前一个状态只与当前状态有关，而与其他状态无关，马尔科夫链体现的是状态空间的转换关系，下一个状态只决定于当前的状态。

&emsp;&emsp;下面举一个例子。

&emsp;&emsp;社会学家经常把人按其经济状况分成3类：下层(`lower-class`)、中层(`middle-class`)、上层(`upper-class`)，我们用1,2,3 分别代表这三个阶层。
社会学家们发现决定一个人的收入阶层的最重要的因素就是其父母的收入阶层。如果一个人的收入属于下层类别，那么他的孩子属于下层收入的概率是 0.65, 属于中层收入的概率是 0.28,
属于上层收入的概率是 0.07。事实上，从父代到子代，收入阶层的变化的转移概率如下

<div  align="center"><img src="imgs/table-1.jpg" width = "350" height = "200" alt="" align="center" /></div>

<div  align="center"><img src="imgs/markov-transition.png" width = "350" height = "200" alt="" align="center" /></div>

&emsp;&emsp;使用矩阵的表示方式，转移概率矩阵记为

$$P=\begin{bmatrix}
  0.65 &  0.28 & 0.07 \\\
  0.15& 0.67 & 0.18 \\\
  0.12 & 0.36 & 0.52
  \end{bmatrix}$$

&emsp;&emsp;假设当前这一代人处在下层、中层、上层的人的比例是概率分布向量$\pi_0=[\pi_0(1),\pi_0(2),\pi_0(3)]$,那么他们的子女的分布比例将是$\pi_1=\pi_0P$,
他们的孙子代的分布比例将是$\pi_2=\pi_1P=\pi_0P^{2}$,第n代子孙的收入分布比例将是$\pi_n=\pi_{n-1}P=\pi_0P^{n}$。

&emsp;&emsp;假设初始概率分布为$\pi_0=(0.2,0.3,0.5)$则我们可以计算前$n$代人的分布状况。

&emsp;&emsp;代码如下：

```R
p<-matrix(c(0.65,0.15,0.12,
            + 0.28,0.67,0.36,
            + 0.07,0.18,0.52),nrow = 3, ncol = 3);
a<-c(0.2,0.3,0.5);
result = a;
for (i in 1:10){
  a=a%*%p;
  result = rbind(result,a);
}
show(result);
```

&emsp;&emsp;结果如下：

```
0.2000000 0.3000000 0.5000000
0.2350000 0.4370000 0.3280000
0.2576600 0.4766700 0.2656700
0.2708599 0.4871549 0.2419852
0.2781704 0.4893492 0.2324804
0.2821108 0.4894446 0.2284446
0.2842021 0.4891590 0.2266390
0.2853019 0.4889031 0.2257950
0.2858771 0.4887358 0.2253871
0.2861769 0.4886379 0.2251851
0.2863329 0.4885836 0.2250835
```

&emsp;&emsp;我们发现，最终会趋于稳定值。我们把初始分布改为$\pi_0=(0.5,0.4,0.1)$,继续迭代：

```
0.5000000 0.4000000 0.1000000
0.3970000 0.4440000 0.1590000
0.3437300 0.4658800 0.1903900
0.3161533 0.4769244 0.2069223
0.3018690 0.4825543 0.2155767
0.2944672 0.4854423 0.2200905
0.2906309 0.4869297 0.2224394
0.2886423 0.4876977 0.2236600
0.2876113 0.4880949 0.2242937
0.2870769 0.4883005 0.2246226
0.2867997 0.4884070 0.2247932
```
最终还是收敛于相同的值。即这个最终分布于初始状态无关。我们迭代转移矩阵$P$，得到：

$$P^{100}=
  \left[
  \begin{array}{ccc}
      0.2865014 & 0.4885216 & 0.224977\\
  0.2865014 & 0.4885216 & 0.224977\\
  0.2865014 & 0.4885216 & 0.224977\\
  \end{array}
  \right]$$


&emsp;&emsp;于是引出如下定理：

&emsp;&emsp;**马尔科夫链定理:**如果一个非周期马尔科夫链具有转移概率矩阵$P$，且它的任何两个状态是连通的，那么$\lim_{n \rightarrow \infty}P_{ij}^{n}$存在且与$i$无关，
记$\lim_{n \rightarrow \infty}P_{ij}^{n} = \pi(j)$,有

- 1 $\lim_{n \rightarrow \infty}P^{n} =\left(
   \begin{align}
   \pi(1)  \pi(2) \ldots \pi(j) \ldots \\\
   \pi(1) \pi(2)  \ldots \pi(j) \ldots \\\
   \vdots \vdots \vdots \vdots \vdots \\\
   \end{align}
   \right)$

- 2 $\pi(j) = \sum_{i=0}^{\infty}\pi(i)P_{ij}$

&emsp;&emsp;$\pi$是方程$\pi~P=\pi$的唯一非负解,其中$\pi=[\pi(1),\pi(2),\ldots,\pi(j),\ldots],~\sum_{i=0}^{\infty}\pi(i)=1$,$\pi$称为马尔科夫链的平稳分布。

&emsp;&emsp;马尔科夫链定理非常重要，所有的`MCMC`方法都是以这个定理作为理论基础的。定理内容有一些需要解释说明的地方:

- 该定理中马氏链的状态不要求有限，可以是有无穷多个的；

- 定理中的“非周期“这个概念不解释，因为我们遇到的绝大多数马氏链都是非周期的；

- 两个状态$i$,$j$是连通并非指$i$可以直接一步转移到$j$($P_ij>0$),而是指$i$可以通过有限的$n$步转移到达$j$($P_{ij}^{n}>0$)。
马氏链的任何两个状态是连通的含义是指存在一个$n$,使得矩阵$P^{n}$中任何一个元素的值大于零。

- 我们用$X_i$表示在马氏链上跳转第$i$步所处的状态,如果$\lim_{n \rightarrow \infty}P_{ij}^{n} = \pi(j)$存在,很容易证明定理第二个结论。

$$P(X_{n+1}=j) = \sum_{i=1}^{\infty}P(X_{n}=i)P(X_{n+1}=j\mid x_{n}=i)=\sum_{i=1}^{\infty}P(X_{n}=i) p_{ij}$$









